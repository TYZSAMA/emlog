<?php
/**
 * 生成文本缓存类
 * @copyright (c) 2008, Emlog All Rights Reserved
 * @version emlog-2.7.0
 * $Id$
 */


class mkcache {

	var $cachePath;
	var $dbhd;

	function mkcache($cachePath, $dbhandle)
	{
		$this->cachePath = $cachePath;
		$this->dbhd = $dbhandle;
	}
	/**
	 * 站点配置缓存
	 *
	 * @param unknown_type $cf
	 */
	function mc_config($cf)
	{
		$show_config=$this->dbhd->fetch_array($this->dbhd->query("SELECT * FROM ".DB_PREFIX."config"));
		$config_cache = array(
		'sitekey' => htmlspecialchars($show_config['site_key']),
		'blogname' =>htmlspecialchars(stripslashes($show_config['blogname'])),
		'bloginfo'=>htmlspecialchars(stripslashes($show_config['bloginfo'])),
		'index_lognum' =>$show_config['index_lognum'],
		'index_twnum' =>$show_config['index_twnum'],
		'index_comment_num' =>$show_config['index_comnum'],
		'ischkcomment'=>$show_config['ischkcomment'],
		'isurlrewrite'=>$show_config['isurlrewrite'],
		'isgzipenable'=>$show_config['isgzipenable'],
		'istrackback'=>$show_config['istrackback'],
		'comment_code'=>$show_config['comment_code'],
		'login_code'=>$show_config['login_code'],
		'comment_subnum'=>$show_config['comment_subnum'],
		'nonce_templet'=>$show_config['nonce_templet'],
		'blogurl'=>htmlspecialchars($show_config['blogurl']),
		'icp'=>htmlspecialchars($show_config['icp']),
		'timezone'=>$show_config['timezone'],
		'exarea'=>$show_config['exarea'],
		'edition'=>EM_VERSION
		);
		$cacheData = serialize($config_cache);
		$this->cacheWrite($cacheData,$cf);
	}
	/**
	 * 个人资料缓存
	 *
	 * @param unknown_type $cf
	 */
	function mc_blogger($cf)
	{
		$blogger = $this->dbhd->fetch_one_array("select * from ".DB_PREFIX."user ");
		$icon = '';
		if($blogger['photo'])
		{
			$photosrc = substr($blogger['photo'],3);
			$imgsize = chImageSize($blogger['photo'],ICON_MAX_W,ICON_MAX_H);
			$icon = "<img src=\"".htmlspecialchars($photosrc)."\" width=\"{$imgsize['w']}\" height=\"{$imgsize['h']}\" alt=\"blogger\" />";
		}
		$user_cache = array(
		'photo' => $icon,
		'name' =>htmlspecialchars($blogger['nickname']),
		'mail'	=>htmlspecialchars($blogger['email']),
		'des'=>$blogger['description']
		);
		$cacheData = serialize($user_cache);
		$this->cacheWrite($cacheData,$cf);
	}
	/**
	 * 博客统计缓存
	 *
	 * @param unknown_type $cf
	 */
	function mc_sta($cf)
	{
		$dh = $this->dbhd->fetch_one_array("select * from ".DB_PREFIX."statistics");
		$lognum = $this->dbhd->num_rows($this->dbhd->query("SELECT gid FROM ".DB_PREFIX."blog WHERE hide='n' "));
		$comnum = $this->dbhd->num_rows($this->dbhd->query("SELECT cid FROM ".DB_PREFIX."comment WHERE hide='n' "));
		$tbnum = $this->dbhd->num_rows($this->dbhd->query("SELECT gid FROM ".DB_PREFIX."trackback "));
		$twnum = $this->dbhd->num_rows($this->dbhd->query("SELECT id FROM ".DB_PREFIX."twitter "));
		$hidecom = $this->dbhd->num_rows($this->dbhd->query("SELECT gid FROM ".DB_PREFIX."comment where hide='y' "));

		$sta_cache = array(
		'day_view_count' => $dh['day_view_count'],
		'view_count' =>$dh['view_count'],
		'lognum'=>$lognum,
		'comnum'=>$comnum,
		'twnum'=>$twnum,
		'hidecom'=>$hidecom,
		'tbnum'=>$tbnum
		);
		$cacheData = serialize($sta_cache);
		$this->cacheWrite($cacheData,$cf);
	}
	/**
	 * 最新评论缓存
	 *
	 * @param unknown_type $cf
	 */
	function mc_comment($cf)
	{
		$show_config=$this->dbhd->fetch_array($this->dbhd->query("SELECT * FROM ".DB_PREFIX."config"));
		$index_comment_num = $show_config['index_comnum'];
		$comment_subnum = $show_config['comment_subnum'];
		$query=$this->dbhd->query("SELECT cid,gid,comment,date,poster,reply FROM ".DB_PREFIX."comment WHERE hide='n' ORDER BY cid DESC LIMIT 0, $index_comment_num ");
		$com_cache = array();
		while($show_com=$this->dbhd->fetch_array($query))
		{
			$com_cache[] = array(
			'url' => "index.php?action=showlog&gid={$show_com['gid']}#{$show_com['cid']}",
			'name' => htmlspecialchars($show_com['poster']),
			'content' => htmlClean2(subString($show_com['comment'],0,$comment_subnum)),
			'reply' => $show_com['reply']
			);
		}
		$cacheData = serialize($com_cache);
		$this->cacheWrite($cacheData,$cf);
	}
	/**
	 * 侧边栏标签缓存
	 *
	 * @param unknown_type $cf
	 */
	function mc_tags($cf)
	{
		$tag_cache = array();
		$query=$this->dbhd->query("SELECT max(usenum),min(usenum),count(*) FROM ".DB_PREFIX."tag");
		$row = $this->dbhd->fetch_row($query);
		$maxuse = $row[0];
		$minuse = $row[1];
		$tagnum = $row[2];
		$spread = ($tagnum>12?12:$tagnum);
		$rank = $maxuse-$minuse;
		$rank = ($rank==0?1:$rank);
		$rank = $spread/$rank;
		$query=$this->dbhd->query("SELECT tagname,usenum FROM ".DB_PREFIX."tag");
		while($show_tag = $this->dbhd->fetch_array($query))
		{
			//maxfont:22pt,minfont:10pt
			$fontsize=10+round(($show_tag['usenum']-$minuse)*$rank);
			$tag_cache[] = array(
			'tagurl' => urlencode($show_tag['tagname']),
			'tagname' => htmlspecialchars($show_tag['tagname']),
			'fontsize' => $fontsize,
			'usenum' => $show_tag['usenum']
			);
		}
		$cacheData = serialize($tag_cache);
		$this->cacheWrite($cacheData,$cf);
	}
	/**
	 * 友站缓存
	 *
	 * @param unknown_type $cf
	 */
	function mc_link($cf)
	{
		$link_cache = array();
		$query=$this->dbhd->query("SELECT siteurl,sitename,description FROM ".DB_PREFIX."link ORDER BY taxis ASC");
		while($show_link=$this->dbhd->fetch_array($query))
		{
			$link_cache[] = array(
			'link'=>htmlspecialchars($show_link['sitename']),
			'url'=>htmlspecialchars($show_link['siteurl']),
			'des'=>htmlspecialchars($show_link['description'])
			);
		}
		$cacheData = serialize($link_cache);
		$this->cacheWrite($cacheData,$cf);
	}
	/**
	 * twitter缓存
	 *
	 * @param unknown_type $cf
	 */
	function mc_twitter($cf)
	{
		$show_config=$this->dbhd->fetch_array($this->dbhd->query("SELECT index_twnum FROM ".DB_PREFIX."config"));
		$index_twnum = $show_config['index_twnum']+1;
		$query=$this->dbhd->query("SELECT * FROM ".DB_PREFIX."twitter ORDER BY id DESC LIMIT $index_twnum");
		$tw_cache = array();
		while($show_tw=$this->dbhd->fetch_array($query))
		{
			$tw_cache[] = array(
			'content' => htmlspecialchars($show_tw['content']),
			'date' => $show_tw['date'],
			'id' => $show_tw['id']
			);
		}
		$cacheData = serialize($tw_cache);
		$this->cacheWrite($cacheData,$cf);
	}
	/**
	 * 日志归档缓存
	 *
	 * @param unknown_type $cf
	 */
	function mc_record($cf)
	{
		global $isurlrewrite;
		$query=$this->dbhd->query("select date from ".DB_PREFIX."blog WHERE hide='n' ORDER BY date DESC");
		$record='xxxx_x';
		$p = 0;
		$lognum = 1;
		$dang_cache = array();
		while($show_record=$this->dbhd->fetch_array($query))
		{
			$f_record=date('Y_n',$show_record['date']);
			if ($record!=$f_record){
				$h = $p-1;
				if($h!=-1)
				{
					$dang_cache[$h]['lognum'] = $lognum;
				}
				if($isurlrewrite == 'y')
				{
					$dang_cache[$p] = array(
					'record'=>date("Y年n月",$show_record['date']),
					'url'=>"record-".date("Ym",$show_record['date']).".html"
					);
				}else{
					$dang_cache[$p] = array(
					'record'=>date("Y年n月",$show_record['date']),
					'url'=>"index.php?record=".date("Ym",$show_record['date'])
					);
				}
				$p++;
				$lognum = 1;
			}else{
				$lognum++;
				continue;
			}
			$record=$f_record;
		}
		$j = $p-1;
		if($j>=0)
		{
			$dang_cache[$j]['lognum'] = $lognum;
		}

		$cacheData = serialize($dang_cache);
		$this->cacheWrite($cacheData,$cf);
	}
	/**
	 * 日志标签缓存
	 *
	 * @param unknown_type $cf
	 */
	function mc_logtags($cf)
	{
		$sql="SELECT gid FROM ".DB_PREFIX."blog ORDER BY top DESC ,date DESC";
		$query1=$this->dbhd->query($sql);
		$log_cache_tags = array();
		while($show_log=$this->dbhd->fetch_array($query1))
		{
			$tag = '';
			$gid = $show_log['gid'];
			//tag
			$tquery = "SELECT tagname FROM ".DB_PREFIX."tag WHERE gid LIKE '%,$gid,%' " ;
			$result = $this->dbhd->query($tquery);
			$tagnum = $this->dbhd->num_rows($result);
			if($tagnum>0)
			{
				while($show_tag=$this->dbhd->fetch_array($result))
				{
					$tag .= "	<a href=\"./?tag=".urlencode($show_tag['tagname'])."\">".htmlspecialchars($show_tag['tagname']).'</a>';
				}
			}else{
				$tag = '';
			}
			$log_cache_tags[$show_log['gid']] = $tag;
			unset($tag);
		}
		$cacheData = serialize($log_cache_tags);
		$this->cacheWrite($cacheData,$cf);
	}
	/**
	 * 日志附件缓存
	 *
	 * @param unknown_type $cf
	 * @param unknown_type $cont_attid 嵌入内容中的附件id数组
	 */
	function mc_logatts($cf,$cont_attid='')
	{
		$sql="SELECT gid,attcache FROM ".DB_PREFIX."blog ORDER BY top DESC ,date DESC";
		$query1=$this->dbhd->query($sql);
		$log_cache_atts = array();
		while($rows=$this->dbhd->fetch_array($query1))
		{
			$gid = $rows['gid'];
			$att_img = '';
			$attachment = '';
			//attachment
			$attquery = $this->dbhd->query("SELECT * FROM ".DB_PREFIX."attachment WHERE blogid=$gid ");
			while($show_attach=$this->dbhd->fetch_array($attquery)){
				$cont_attid = unserialize($rows['attcache']);
				if($cont_attid && in_array($show_attach['aid'],$cont_attid))
				{
					continue;
				}
				$att_path = $show_attach['filepath'];//eg: ../uploadfile/200710/b.jpg
				$atturl = substr($att_path,3);//eg: uploadfile/200710/b.jpg
				$postfix = strtolower(substr(strrchr($show_attach['filename'], "."),1));//文件后缀
				if($postfix == 'jpg' OR $postfix == 'jpeg' OR $postfix == 'gif' OR $postfix == 'png')
				{
					$imgsrc = $atturl;
					if(substr(basename($imgsrc),0,5) == 'thum-')
					{
						$imgsrc2 = str_replace('thum-','',$imgsrc);
					}else{
						$imgsrc2 = $imgsrc;
					}
					$imgsize = chImageSize($att_path,IMG_ATT_MAX_W,IMG_ATT_MAX_H);
					$att_img .= "<br /><br /><a href=\"$imgsrc2\" target=\"_blank\"><img src=\"$imgsrc\" width=\"{$imgsize['w']}\" height=\"{$imgsize['h']}\" border=\"0\" alt=\"点击查看原图\" /></a>";
				}else{
					$file_atturl = $atturl;
					$attachment .= "<br /><a href=\"$file_atturl\" target=\"_blank\">{$show_attach['filename']}</a>\t".changeFileSize($show_attach['filesize']);
				}
			}
			$log_cache_atts[$gid] = array(
			'attachment'=>$attachment,
			'att_img'=>$att_img
			);
			unset($attachment);
			unset($att_img);
		}
		$cacheData = serialize($log_cache_atts);
		$this->cacheWrite($cacheData,$cf);
	}

	/**
	 * 写入缓存
	 *
	 * @param unknown_type $cacheDate
	 * @param unknown_type $cachefile
	 */
	function cacheWrite ($cacheDate,$cachefile)
	{
		$cachefile = $this->cachePath.$cachefile;
		@ $fp = fopen($cachefile, 'wb') OR sysMsg('打开缓存文件失败，请查看文件权限');
		@ $fw =	fwrite($fp,$cacheDate) OR sysMsg('写入缓存失败，请查看文件权限');
		fclose($fp);
	}

	/**
	 * 读取缓存文件
	 *
	 * @param  $filename 缓存文件
	 * @return unknown
	 */
	function readCache($cachefile)
	{
		$cachefile = $this->cachePath.$cachefile;
		if(@$fp = fopen($cachefile, 'r'))
		{
			@$data = fread($fp,filesize($cachefile));
			fclose($fp);
		}
		return unserialize($data);
	}
}
?>